# 동시성 및 예외 테스트 시나리오 (Concurrency & Exception Plan)

본 문서는 Sprint 0에서 검증해야 할 4가지 핵심 시나리오를 정의합니다.

## T01. 예약 동시성 (The "Lucky 3" Test)
- **상황**: 정원 3명인 슬롯(`slot_01`)에 0.1초 간격으로 10명의 유저가 예약 시도.
- **조건**: 
  - 각 요청은 고유한 `patientId`와 `idempotencyKey`를 가짐.
  - 서버는 Random Latency (50ms ~ 200ms)를 가짐 (현실 모사).
- **검증 항목**:
  - `Appointment` 테이블에 정확히 **3건**만 생성되었는가? (Count == 3)
  - `Slot.bookedCount`가 **3**인가?
  - `Slot.status`가 **FULL**로 변경되었는가?
  - 생성된 3건에 대한 `AuditLog` 생성 여부.

## T02. Idempotency (네트워크 중복 전송 방지)
- **상황**: 유저 A가 "예약하기"를 눌렀으나 네트워크 지연으로 응답을 못 받아, 2초 뒤 다시 누름. (동일 `idempotencyKey` 사용)
- **조건**: 1초 간격으로 동일 Payload + 동일 Key로 2회 요청 발송.
- **검증 항목**:
  - 첫 번째 요청: `201 Created`
  - 두 번째 요청: `200 OK` (또는 `409 Conflict` - 정책에 따름) 반환하되, **신규 예약이 생성되면 안 됨**.
  - `Appointment` 테이블 Count는 1이어야 함.

## T03. 데드락(Deadlock) 회피 테스트
- **상황**: 유저 A와 B가 서로 다른 슬롯에 동시에 예약을 시도, 동시에 취소 로직도 수행. (교차 트랜잭션)
- **검증 항목**:
  - DB Lock Timeout 발생 없이 두 트랜잭션이 모두 정상 처리(Commit) 되거나, 하나만 롤백되고 시스템이 멈추지 않아야 함.

## T04. 슬롯 생성 경계값 테스트
- **상황**: 점심시간(12:30~13:30) 설정 시 슬롯 생성.
- **검증 항목**:
  - 12:20 슬롯 생성 (O)
  - 12:30 슬롯 미생성 (X)
  - 13:20 슬롯 미생성 (X)
  - 13:30 슬롯 생성 (O)
